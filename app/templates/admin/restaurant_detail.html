{% extends "admin/base.html" %}
{% block title %}{{ restaurant.name }}{% endblock %}
{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 16px;
        padding: 30px;
        color: white;
        margin-bottom: 25px;
    }
    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .status-pill.active { background: #27ae60; }
    .status-pill.inactive { background: #e74c3c; }
    .action-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .action-btn:hover { background: rgba(255,255,255,0.25); color: white; }
    .stats-row { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .stat-box {
        flex: 1;
        min-width: 120px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-box .value { font-size: 1.8rem; font-weight: 700; color: #1a1a2e; }
    .stat-box .label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .card-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        overflow: hidden;
    }
    .card-section-header {
        padding: 18px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card-section-header h6 { margin: 0; font-weight: 600; color: #1a1a2e; }
    .card-section-body { padding: 20px; }
    .qr-box {
        text-align: center;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 12px;
    }
    .qr-box img { max-width: 160px; border-radius: 8px; margin-bottom: 15px; }
    .menu-link {
        display: inline-block;
        background: #f0f0f0;
        padding: 8px 16px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 15px;
    }
    .category-block { margin-bottom: 15px; }
    .category-header {
        background: #1a1a2e;
        color: white;
        padding: 12px 16px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .category-header h6 { margin: 0; font-weight: 600; }
    .category-items { border: 1px solid #eee; border-top: none; border-radius: 0 0 8px 8px; }
    .menu-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f5f5f5;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item-thumb {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        background: #eee;
        margin-right: 12px;
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ccc;
    }
    .menu-item-details { flex: 1; }
    .menu-item-name { font-weight: 600; font-size: 0.95rem; color: #333; }
    .menu-item-price { color: #667eea; font-weight: 600; }
    .menu-item-status { font-size: 0.75rem; color: #888; }
    .btn-icon { padding: 5px 10px; }
    .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f5f5f5; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #888; font-size: 0.9rem; }
    .info-value { font-weight: 500; color: #333; }
    .order-row {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    .order-row:last-child { border-bottom: none; }
    .order-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .order-badge.pending { background: #fff3cd; color: #856404; }
    .order-badge.preparing { background: #cce5ff; color: #004085; }
    .order-badge.ready { background: #d4edda; color: #155724; }
    .order-badge.completed { background: #e2e3e5; color: #383d41; }
</style>

<nav class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.restaurants') }}">Restaurants</a></li>
        <li class="breadcrumb-item active">{{ restaurant.name }}</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <div class="d-flex align-items-center gap-3 mb-2">
                <h2 class="mb-0">{{ restaurant.name }}</h2>
                <span class="status-pill {{ 'active' if restaurant.is_active else 'inactive' }}">
                    <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                    {{ 'Active' if restaurant.is_active else 'Inactive' }}
                </span>
            </div>
            <p class="mb-0 opacity-75">
                {% if restaurant.address %}<i class="bi bi-geo-alt me-1"></i>{{ restaurant.address }}{% endif %}
                {% if restaurant.phone %}<span class="mx-2">•</span><i class="bi bi-telephone me-1"></i>{{ restaurant.phone }}{% endif %}
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <form action="{{ url_for('admin.toggle_restaurant', restaurant_id=restaurant.id) }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="action-btn">
                    <i class="bi bi-{{ 'pause' if restaurant.is_active else 'play' }} me-1"></i>{{ 'Disable' if restaurant.is_active else 'Enable' }}
                </button>
            </form>
            <button class="action-btn" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                <i class="bi bi-folder-plus me-1"></i>Category
            </button>
            <button class="action-btn" data-bs-toggle="modal" data-bs-target="#createItemModal">
                <i class="bi bi-plus-lg me-1"></i>Item
            </button>
            <button class="action-btn" data-bs-toggle="modal" data-bs-target="#importMenuModal">
                <i class="bi bi-upload me-1"></i>Import
            </button>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="stats-row">
    <div class="stat-box">
        <div class="value">{{ categories|length }}</div>
        <div class="label">Categories</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ total_menu_items }}</div>
        <div class="label">Menu Items</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ restaurant.orders|length }}</div>
        <div class="label">Orders</div>
    </div>
    <div class="stat-box">
        <div class="value">${{ "%.0f"|format(restaurant.orders|sum(attribute='total_price')) }}</div>
        <div class="label">Revenue</div>
    </div>
</div>

<div class="row">
    <!-- Left Column - Menu -->
    <div class="col-lg-8">
        <div class="card-section">
            <div class="card-section-header">
                <h6><i class="bi bi-list-ul me-2"></i>Menu</h6>
                {% if categories %}
                <a href="{{ url_for('admin.export_menu_csv', restaurant_id=restaurant.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-download me-1"></i>Export
                </a>
                {% endif %}
            </div>
            <div class="card-section-body">
                {% if categories %}
                {% for category in categories %}
                <div class="category-block">
                    <div class="category-header">
                        <h6>{{ category.name }} <span class="opacity-50">({{ category.items|length }})</span></h6>
                        <div>
                            <span class="badge bg-{{ 'success' if category.is_active else 'secondary' }} me-2">{{ 'Active' if category.is_active else 'Inactive' }}</span>
                            <form action="{{ url_for('admin.toggle_category', restaurant_id=restaurant.id, category_id=category.id) }}" method="POST" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-light btn-icon"><i class="bi bi-{{ 'pause' if category.is_active else 'play' }}"></i></button>
                            </form>
                            <form action="{{ url_for('admin.delete_category', restaurant_id=restaurant.id, category_id=category.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete category?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-light btn-icon text-danger"><i class="bi bi-trash"></i></button>
                            </form>
                        </div>
                    </div>
                    <div class="category-items">
                        {% if category.items %}
                        {% for item in category.items %}
                        <div class="menu-item">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" class="menu-item-thumb">
                            {% else %}
                            <div class="menu-item-thumb"><i class="bi bi-image"></i></div>
                            {% endif %}
                            <div class="menu-item-details">
                                <div class="menu-item-name">{{ item.name }}</div>
                                <div class="menu-item-status">
                                    <span class="menu-item-price">${{ "%.2f"|format(item.price) }}</span>
                                    {% if not item.is_available %}<span class="text-danger ms-2">• Unavailable</span>{% endif %}
                                </div>
                            </div>
                            <div>
                                <form action="{{ url_for('admin.toggle_item', restaurant_id=restaurant.id, item_id=item.id) }}" method="POST" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if item.is_available else 'success' }} btn-icon"><i class="bi bi-{{ 'pause' if item.is_available else 'play' }}"></i></button>
                                </form>
                                <form action="{{ url_for('admin.delete_item', restaurant_id=restaurant.id, item_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete item?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger btn-icon"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-3">No items</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-journal-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No menu yet</h5>
                    <p class="text-muted">Add your first category to start building the menu</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                        <i class="bi bi-plus-lg me-1"></i>Add Category
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- QR Code -->
        <div class="card-section">
            <div class="card-section-header">
                <h6><i class="bi bi-qr-code me-2"></i>QR Code</h6>
            </div>
            <div class="card-section-body">
                <div class="qr-box">
                    {% if restaurant.qr_code_path %}
                    <img src="/static/qrcodes/{{ restaurant.qr_code_path }}" alt="QR Code">
                    <div class="menu-link">/menu/{{ restaurant.public_id }}</div>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="{{ url_for('admin.download_restaurant_qr', restaurant_id=restaurant.id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-download me-1"></i>Download
                        </a>
                        <form action="{{ url_for('admin.generate_restaurant_qr_admin', restaurant_id=restaurant.id) }}" method="POST" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Regenerate</button>
                        </form>
                    </div>
                    {% else %}
                    <i class="bi bi-qr-code text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">No QR code generated</p>
                    <form action="{{ url_for('admin.generate_restaurant_qr_admin', restaurant_id=restaurant.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Generate</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Owner -->
        <div class="card-section">
            <div class="card-section-header">
                <h6><i class="bi bi-person me-2"></i>Owner</h6>
            </div>
            <div class="card-section-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div style="width:45px;height:45px;border-radius:50%;background:#667eea;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;">
                        {{ restaurant.owner.username[0]|upper }}
                    </div>
                    <div>
                        <div class="fw-bold">{{ restaurant.owner.username }}</div>
                        <div class="text-muted small">{{ restaurant.owner.email }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details -->
        <div class="card-section">
            <div class="card-section-header">
                <h6><i class="bi bi-info-circle me-2"></i>Details</h6>
            </div>
            <div class="card-section-body">
                <div class="info-row">
                    <span class="info-label">ID</span>
                    <code>{{ restaurant.public_id }}</code>
                </div>
                <div class="info-row">
                    <span class="info-label">Created</span>
                    <span class="info-value">{{ restaurant.created_at.strftime('%b %d, %Y') }}</span>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="card-section">
            <div class="card-section-header">
                <h6><i class="bi bi-clock-history me-2"></i>Recent Orders</h6>
                <a href="{{ url_for('admin.orders', restaurant_id=restaurant.id) }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-section-body" style="max-height: 250px; overflow-y: auto;">
                {% if orders %}
                {% for order in orders[:8] %}
                <div class="order-row">
                    <div class="flex-grow-1">
                        <div class="fw-semibold small">#{{ order.order_number[:8] }}</div>
                        <div class="text-muted" style="font-size:0.75rem;">${{ "%.2f"|format(order.total_price) }} • {{ order.created_at.strftime('%H:%M') }}</div>
                    </div>
                    <span class="order-badge {{ order.status }}">{{ order.status|title }}</span>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted py-3">No orders yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="createCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.create_restaurant_category', restaurant_id=restaurant.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header"><h5 class="modal-title">Add Category</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Name *</label><input type="text" name="name" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-6"><label class="form-label">Sort Order</label><input type="number" name="sort_order" class="form-control" value="0"></div>
                        <div class="col-6 d-flex align-items-end"><div class="form-check"><input class="form-check-input" type="checkbox" name="is_active" checked><label class="form-check-label">Active</label></div></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Create</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.create_restaurant_item', restaurant_id=restaurant.id) }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header"><h5 class="modal-title">Add Menu Item</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-8"><label class="form-label">Name *</label><input type="text" name="name" class="form-control" required></div>
                        <div class="col-4"><label class="form-label">Price *</label><input type="text" name="price" class="form-control" required></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="2"></textarea></div>
                    <div class="mb-3"><label class="form-label">Category *</label><select name="category_id" class="form-select" required><option value="">Select</option>{% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}</select></div>
                    <div class="mb-3"><label class="form-label">Image</label><input type="file" name="image" class="form-control" accept="image/*"></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="is_available" checked><label class="form-check-label">Available</label></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Create</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="importMenuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.import_menu_csv', restaurant_id=restaurant.id) }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header"><h5 class="modal-title">Import Menu</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        <strong>CSV Format:</strong> category, name, price, description (optional), is_available (optional)
                        <div class="mt-2"><a href="{{ url_for('admin.download_menu_template', restaurant_id=restaurant.id) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download me-1"></i>Download Template</a></div>
                    </div>
                    <div class="mb-3"><label class="form-label">CSV File *</label><input type="file" name="csv_file" class="form-control" accept=".csv" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-upload me-1"></i>Import</button></div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

