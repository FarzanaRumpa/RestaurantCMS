{% extends "admin/base.html" %}
{% block title %}Media & Theme Management{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-palette me-2"></i>Media & Theme Management</h2>
        <p class="text-muted mb-0">Manage website images, banners, and color themes</p>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="mediaTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="theme-tab" data-bs-toggle="tab" data-bs-target="#theme" type="button">
            <i class="bi bi-brush me-2"></i>Theme & Colors
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button">
            <i class="bi bi-images me-2"></i>Media Library
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="banners-tab" data-bs-toggle="tab" data-bs-target="#banners" type="button">
            <i class="bi bi-card-image me-2"></i>Banners
        </button>
    </li>
</ul>

<div class="tab-content" id="mediaTabContent">
    <!-- Theme & Colors Tab -->
    <div class="tab-pane fade show active" id="theme" role="tabpanel">
        <form action="{{ url_for('admin.save_theme') }}" method="POST" id="themeForm">
            <div class="row">
                <!-- Hero Section Colors -->
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-stars me-2"></i>Hero Section</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Background Type</label>
                                <select name="hero_bg_type" class="form-select" id="heroBgType" onchange="toggleHeroBgOptions()">
                                    <option value="gradient" {{ 'selected' if theme and theme.hero_bg_type == 'gradient' else '' }}>Gradient</option>
                                    <option value="image" {{ 'selected' if theme and theme.hero_bg_type == 'image' else '' }}>Image</option>
                                    <option value="solid" {{ 'selected' if theme and theme.hero_bg_type == 'solid' else '' }}>Solid Color</option>
                                </select>
                            </div>

                            <div id="gradientOptions">
                                <div class="row">
                                    <div class="col-4">
                                        <label class="form-label">Color 1</label>
                                        <input type="color" name="hero_gradient_start" class="form-control form-control-color w-100"
                                               value="{{ theme.hero_gradient_start if theme else '#6366f1' }}">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Color 2</label>
                                        <input type="color" name="hero_gradient_middle" class="form-control form-control-color w-100"
                                               value="{{ theme.hero_gradient_middle if theme else '#8b5cf6' }}">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Color 3</label>
                                        <input type="color" name="hero_gradient_end" class="form-control form-control-color w-100"
                                               value="{{ theme.hero_gradient_end if theme else '#ec4899' }}">
                                    </div>
                                </div>
                            </div>

                            <div id="imageOptions" style="display: none;">
                                <label class="form-label">Background Image</label>
                                <input type="file" name="hero_bg_image" class="form-control" accept="image/*">
                                {% if theme and theme.hero_bg_image %}
                                <div class="mt-2">
                                    <img src="{{ theme.hero_bg_image.file_path }}" class="img-thumbnail" style="max-height: 100px;">
                                </div>
                                {% endif %}
                                <div class="mt-2">
                                    <label class="form-label">Overlay Opacity</label>
                                    <input type="range" name="hero_overlay_opacity" class="form-range" min="0" max="1" step="0.1"
                                           value="{{ theme.hero_overlay_opacity if theme else 0.5 }}">
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Text Color</label>
                                <input type="color" name="hero_text_color" class="form-control form-control-color"
                                       value="{{ theme.hero_text_color if theme else '#ffffff' }}">
                            </div>

                            <!-- Preview -->
                            <div class="mt-4">
                                <label class="form-label">Preview</label>
                                <div id="heroPreview" class="rounded p-4 text-center"
                                     style="background: linear-gradient(-45deg, #6366f1, #8b5cf6, #ec4899); min-height: 150px;">
                                    <h4 class="text-white mb-2">Hero Title Preview</h4>
                                    <p class="text-white opacity-75">Subtitle text preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Primary Colors -->
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-droplet me-2"></i>Brand Colors</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Primary</label>
                                    <input type="color" name="primary_color" class="form-control form-control-color w-100"
                                           value="{{ theme.primary_color if theme else '#6366f1' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Secondary</label>
                                    <input type="color" name="secondary_color" class="form-control form-control-color w-100"
                                           value="{{ theme.secondary_color if theme else '#ec4899' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Accent</label>
                                    <input type="color" name="accent_color" class="form-control form-control-color w-100"
                                           value="{{ theme.accent_color if theme else '#06b6d4' }}">
                                </div>
                            </div>

                            <hr>

                            <h6 class="mb-3">Background Colors</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Body</label>
                                    <input type="color" name="body_bg_color" class="form-control form-control-color w-100"
                                           value="{{ theme.body_bg_color if theme else '#ffffff' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Light Section</label>
                                    <input type="color" name="section_bg_light" class="form-control form-control-color w-100"
                                           value="{{ theme.section_bg_light if theme else '#f8fafc' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Dark Section</label>
                                    <input type="color" name="section_bg_dark" class="form-control form-control-color w-100"
                                           value="{{ theme.section_bg_dark if theme else '#1e1b4b' }}">
                                </div>
                            </div>

                            <hr>

                            <h6 class="mb-3">Text Colors</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Primary Text</label>
                                    <input type="color" name="text_primary" class="form-control form-control-color w-100"
                                           value="{{ theme.text_primary if theme else '#334155' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Secondary Text</label>
                                    <input type="color" name="text_secondary" class="form-control form-control-color w-100"
                                           value="{{ theme.text_secondary if theme else '#64748b' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Light Text</label>
                                    <input type="color" name="text_light" class="form-control form-control-color w-100"
                                           value="{{ theme.text_light if theme else '#ffffff' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logo & Branding -->
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-shop me-2"></i>Logo & Branding</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Logo Text</label>
                                <input type="text" name="logo_text" class="form-control"
                                       value="{{ theme.logo_text if theme else 'RestaurantPro' }}" maxlength="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Logo Image (optional)</label>
                                <input type="file" name="logo_image" class="form-control" accept="image/*">
                                {% if theme and theme.logo_image %}
                                <div class="mt-2">
                                    <img src="{{ theme.logo_image.file_path }}" class="img-thumbnail" style="max-height: 60px;">
                                </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Favicon</label>
                                <input type="file" name="favicon" class="form-control" accept="image/x-icon,image/png">
                                <small class="text-muted">Recommended: 32x32px .ico or .png</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Colors -->
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-layout-text-window-reverse me-2"></i>Footer</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Background Color</label>
                                    <input type="color" name="footer_bg_color" class="form-control form-control-color w-100"
                                           value="{{ theme.footer_bg_color if theme else '#1e1b4b' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Text Color</label>
                                    <input type="color" name="footer_text_color" class="form-control form-control-color w-100"
                                           value="{{ theme.footer_text_color if theme else '#94a3b8' }}">
                                </div>
                            </div>

                            <!-- Footer Preview -->
                            <div id="footerPreview" class="rounded p-3 mt-3" style="background: #1e1b4b;">
                                <span style="color: #94a3b8;">Footer preview text</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetTheme()">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Default
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>Save Theme Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Media Library Tab -->
    <div class="tab-pane fade" id="media" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Media Library</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadMediaModal">
                    <i class="bi bi-cloud-upload me-2"></i>Upload Media
                </button>
            </div>
            <div class="card-body">
                <!-- Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select class="form-select" id="mediaFilter" onchange="filterMedia()">
                            <option value="all">All Media</option>
                            <option value="hero">Hero Images</option>
                            <option value="banner">Banners</option>
                            <option value="logo">Logos</option>
                            <option value="background">Backgrounds</option>
                            <option value="gallery">Gallery</option>
                        </select>
                    </div>
                </div>

                <!-- Media Grid -->
                <div class="row g-3" id="mediaGrid">
                    {% for item in media_items %}
                    <div class="col-6 col-md-4 col-lg-3 media-item" data-category="{{ item.category }}">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="{{ item.file_path }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 p-2">
                                    <span class="badge bg-primary">{{ item.category }}</span>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <p class="card-text small text-truncate mb-1">{{ item.name }}</p>
                                <div class="btn-group btn-group-sm w-100">
                                    <button class="btn btn-outline-primary" onclick="copyMediaUrl('{{ item.file_path }}')">
                                        <i class="bi bi-link"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteMedia({{ item.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-images fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No media uploaded yet</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Banners Tab -->
    <div class="tab-pane fade" id="banners" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Website Banners</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addBannerModal">
                    <i class="bi bi-plus-lg me-2"></i>Add Banner
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Preview</th>
                                <th>Name</th>
                                <th>Section</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for banner in banners %}
                            <tr>
                                <td>
                                    <div class="rounded" style="width: 100px; height: 50px;
                                         background: {% if banner.bg_type == 'gradient' %}linear-gradient(135deg, {{ banner.bg_gradient_start }}, {{ banner.bg_gradient_end }}){% else %}{{ banner.bg_color }}{% endif %};">
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ banner.name }}</strong>
                                    <br><small class="text-muted">{{ banner.title[:30] }}...</small>
                                </td>
                                <td><span class="badge bg-info">{{ banner.section }}</span></td>
                                <td>
                                    {% if banner.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBanner({{ banner.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBanner({{ banner.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-card-image fs-1 d-block mb-2"></i>
                                    No banners created yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Media Modal -->
<div class="modal fade" id="uploadMediaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin.upload_media') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Media</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">File</label>
                        <input type="file" name="file" class="form-control" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            <option value="hero">Hero Image</option>
                            <option value="banner">Banner</option>
                            <option value="logo">Logo</option>
                            <option value="background">Background</option>
                            <option value="gallery">Gallery</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alt Text</label>
                        <input type="text" name="alt_text" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Banner Modal -->
<div class="modal fade" id="addBannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('admin.create_banner') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Add Banner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Banner Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Section</label>
                            <select name="section" class="form-select" required>
                                <option value="hero">Hero</option>
                                <option value="promo">Promotional</option>
                                <option value="cta">Call to Action</option>
                                <option value="footer">Footer</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subtitle</label>
                        <textarea name="subtitle" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Button Text</label>
                            <input type="text" name="cta_text" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Button Link</label>
                            <input type="text" name="cta_link" class="form-control">
                        </div>
                    </div>
                    <hr>
                    <h6>Background</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Type</label>
                            <select name="bg_type" class="form-select">
                                <option value="gradient">Gradient</option>
                                <option value="color">Solid Color</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Color 1</label>
                            <input type="color" name="bg_gradient_start" class="form-control form-control-color w-100" value="#6366f1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Color 2</label>
                            <input type="color" name="bg_gradient_end" class="form-control form-control-color w-100" value="#ec4899">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Text Color</label>
                        <input type="color" name="text_color" class="form-control form-control-color" value="#ffffff">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Banner</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleHeroBgOptions() {
    const type = document.getElementById('heroBgType').value;
    document.getElementById('gradientOptions').style.display = type === 'gradient' ? 'block' : 'none';
    document.getElementById('imageOptions').style.display = type === 'image' ? 'block' : 'none';
}

function filterMedia() {
    const filter = document.getElementById('mediaFilter').value;
    document.querySelectorAll('.media-item').forEach(item => {
        if (filter === 'all' || item.dataset.category === filter) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function copyMediaUrl(url) {
    navigator.clipboard.writeText(window.location.origin + url);
    alert('URL copied to clipboard!');
}

function deleteMedia(id) {
    if (confirm('Are you sure you want to delete this media?')) {
        fetch(`/rock/media/${id}/delete`, { method: 'POST' })
            .then(() => location.reload());
    }
}

function deleteBanner(id) {
    if (confirm('Are you sure you want to delete this banner?')) {
        fetch(`/rock/banners/${id}/delete`, { method: 'POST' })
            .then(() => location.reload());
    }
}

function resetTheme() {
    if (confirm('Reset all theme settings to default?')) {
        document.querySelectorAll('input[type="color"]').forEach(input => {
            input.value = input.defaultValue;
        });
    }
}

// Live preview updates
document.querySelectorAll('#themeForm input[type="color"]').forEach(input => {
    input.addEventListener('input', updatePreviews);
});

function updatePreviews() {
    const start = document.querySelector('input[name="hero_gradient_start"]').value;
    const middle = document.querySelector('input[name="hero_gradient_middle"]').value;
    const end = document.querySelector('input[name="hero_gradient_end"]').value;
    const heroPreview = document.getElementById('heroPreview');
    heroPreview.style.background = `linear-gradient(-45deg, ${start}, ${middle}, ${end})`;

    const footerBg = document.querySelector('input[name="footer_bg_color"]').value;
    const footerText = document.querySelector('input[name="footer_text_color"]').value;
    const footerPreview = document.getElementById('footerPreview');
    footerPreview.style.background = footerBg;
    footerPreview.querySelector('span').style.color = footerText;
}

// Initialize
toggleHeroBgOptions();
</script>
{% endblock %}

