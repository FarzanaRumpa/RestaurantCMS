{% extends "admin/base.html" %}
{% block title %}Contact Message #{{ message.id }}{% endblock %}
{% block content %}
<div class="mb-4">
    <a href="{{ url_for('admin.contact_messages') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Messages
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Message Content -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h4 class="mb-0">
                    {{ message.subject or 'No Subject' }}
                    {% if message.is_spam %}
                    <span class="badge bg-danger ms-2">Spam</span>
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="text-muted">From</h6>
                    <p class="mb-1"><strong>{{ message.name }}</strong></p>
                    <p class="mb-1">
                        <i class="bi bi-envelope me-2"></i>
                        <a href="mailto:{{ message.email }}">{{ message.email }}</a>
                    </p>
                    {% if message.phone %}
                    <p class="mb-1">
                        <i class="bi bi-telephone me-2"></i>
                        <a href="tel:{{ message.phone }}">{{ message.phone }}</a>
                    </p>
                    {% endif %}
                    <p class="text-muted small mb-0">
                        <i class="bi bi-clock me-2"></i>
                        {{ message.created_at.strftime('%B %d, %Y at %I:%M %p') if message.created_at else 'N/A' }}
                    </p>
                </div>

                <hr>

                <div>
                    <h6 class="text-muted">Message</h6>
                    <div class="bg-light p-3 rounded">
                        {{ message.message }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Notes -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-sticky me-2"></i>Admin Notes</h5>
            </div>
            <div class="card-body">
                {% if message.admin_notes %}
                <div class="alert alert-info">
                    {{ message.admin_notes }}
                </div>
                {% endif %}

                <form action="{{ url_for('admin.add_message_note', id=message.id) }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Add/Update Note</label>
                        <textarea name="note" class="form-control" rows="3" placeholder="Internal notes (not visible to customer)">{{ message.admin_notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Note
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Actions</h5>
            </div>
            <div class="card-body">
                <!-- Update Status -->
                <form action="{{ url_for('admin.update_message_status', id=message.id) }}" method="POST" class="mb-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select mb-2">
                        <option value="new" {{ 'selected' if message.status == 'new' else '' }}>New</option>
                        <option value="read" {{ 'selected' if message.status == 'read' else '' }}>Read</option>
                        <option value="replied" {{ 'selected' if message.status == 'replied' else '' }}>Replied</option>
                        <option value="archived" {{ 'selected' if message.status == 'archived' else '' }}>Archived</option>
                        <option value="spam" {{ 'selected' if message.status == 'spam' else '' }}>Spam</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="bi bi-check-circle me-2"></i>Update Status
                    </button>
                </form>

                <hr>

                <!-- Mark/Unmark Spam -->
                <form action="{{ url_for('admin.mark_message_spam', id=message.id) }}" method="POST" class="mb-3">
                    <button type="submit" class="btn btn-sm btn-{{ 'success' if message.is_spam else 'warning' }} w-100">
                        <i class="bi bi-{{ 'check-circle' if message.is_spam else 'exclamation-triangle' }} me-2"></i>
                        {{ 'Unmark as Spam' if message.is_spam else 'Mark as Spam' }}
                    </button>
                </form>

                <!-- Delete -->
                <form action="{{ url_for('admin.delete_contact_message', id=message.id) }}"
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to delete this message?')">
                    <button type="submit" class="btn btn-sm btn-danger w-100">
                        <i class="bi bi-trash me-2"></i>Delete Message
                    </button>
                </form>
            </div>
        </div>

        <!-- Metadata -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Metadata</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Status:</strong><br>
                    {% if message.is_spam %}
                        <span class="badge bg-danger">Spam</span>
                    {% elif message.status == 'new' %}
                        <span class="badge bg-success">New</span>
                    {% elif message.status == 'read' %}
                        <span class="badge bg-info">Read</span>
                    {% elif message.status == 'replied' %}
                        <span class="badge bg-primary">Replied</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ message.status }}</span>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <strong>IP Address:</strong><br>
                    <code>{{ message.ip_address or 'N/A' }}</code>
                </div>

                {% if message.replied_at %}
                <div class="mb-3">
                    <strong>Replied:</strong><br>
                    {{ message.replied_at.strftime('%b %d, %Y %I:%M %p') if message.replied_at else 'N/A' }}
                    {% if message.replied_by %}
                    <br><small class="text-muted">by {{ message.replied_by.username }}</small>
                    {% endif %}
                </div>
                {% endif %}

                <div class="mb-3">
                    <strong>Created:</strong><br>
                    {{ message.created_at.strftime('%b %d, %Y %I:%M %p') if message.created_at else 'N/A' }}
                </div>

                {% if message.updated_at and message.updated_at != message.created_at %}
                <div class="mb-0">
                    <strong>Last Updated:</strong><br>
                    {{ message.updated_at.strftime('%b %d, %Y %I:%M %p') if message.updated_at else 'N/A' }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

