{% extends "admin/base.html" %}
{% block title %}Manage Hero Sections{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-image me-2"></i>Hero Sections</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createHeroModal">
        <i class="bi bi-plus-circle me-2"></i>Add Hero Section
    </button>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="px-4 py-3">Image</th>
                        <th class="py-3">Title</th>
                        <th class="py-3">CTA</th>
                        <th class="py-3">Order</th>
                        <th class="py-3">Status</th>
                        <th class="py-3">Created</th>
                        <th class="py-3 text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hero in hero_sections %}
                    <tr>
                        <td class="px-4">
                            {% if hero.background_image %}
                            <img src="{{ hero.background_image }}" alt="Hero Image" class="img-thumbnail" style="max-width: 80px; max-height: 50px; object-fit: cover;">
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-image"></i> No Image</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-semibold">{{ hero.title }}</div>
                            {% if hero.subtitle %}
                            <small class="text-muted">{{ hero.subtitle[:60] }}...</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if hero.cta_text %}
                            <span class="badge bg-info">{{ hero.cta_text }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ hero.display_order }}</span>
                        </td>
                        <td>
                            <form action="{{ url_for('admin.toggle_hero_section', id=hero.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-{{ 'success' if hero.is_active else 'secondary' }}">
                                    <i class="bi bi-{{ 'check-circle' if hero.is_active else 'x-circle' }}"></i>
                                    {{ 'Active' if hero.is_active else 'Inactive' }}
                                </button>
                            </form>
                        </td>
                        <td class="text-muted small">
                            {{ hero.created_at.strftime('%b %d, %Y') if hero.created_at else 'N/A' }}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editHero({{ hero.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteHero({{ hero.id }}, '{{ hero.title }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            <p class="mb-0">No hero sections yet. Create your first one!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Hero Modal -->
<div class="modal fade" id="createHeroModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('admin.create_hero_section') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Create Hero Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" name="title" class="form-control" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subtitle</label>
                        <textarea name="subtitle" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CTA Button Text</label>
                            <input type="text" name="cta_text" class="form-control" maxlength="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CTA Link</label>
                            <input type="text" name="cta_link" class="form-control" maxlength="500">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-upload me-1"></i>Upload Background Image</label>
                        <input type="file" name="background_image_file" class="form-control" accept=".jpg,.jpeg,.png,.webp" id="createImageUpload">
                        <small class="text-muted">Supported formats: JPG, JPEG, PNG, WEBP (Max 5MB)</small>
                        <div id="createImagePreview" class="mt-2" style="display: none;">
                            <img src="" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Enter Image URL</label>
                        <input type="text" name="background_image" class="form-control" placeholder="https://example.com/image.jpg">
                        <small class="text-muted">Leave empty if uploading a file above</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" name="display_order" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select name="is_active" class="form-select">
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Hero Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Hero Modal -->
<div class="modal fade" id="editHeroModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editHeroForm" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Hero Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" name="title" id="edit_title" class="form-control" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subtitle</label>
                        <textarea name="subtitle" id="edit_subtitle" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CTA Button Text</label>
                            <input type="text" name="cta_text" id="edit_cta_text" class="form-control" maxlength="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CTA Link</label>
                            <input type="text" name="cta_link" id="edit_cta_link" class="form-control" maxlength="500">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Background Image</label>
                        <div id="currentImagePreview" class="mb-2" style="display: none;">
                            <img src="" alt="Current Image" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-upload me-1"></i>Upload New Background Image</label>
                        <input type="file" name="background_image_file" class="form-control" accept=".jpg,.jpeg,.png,.webp" id="editImageUpload">
                        <small class="text-muted">Supported formats: JPG, JPEG, PNG, WEBP (Max 5MB). Leave empty to keep current image.</small>
                        <div id="editImagePreview" class="mt-2" style="display: none;">
                            <img src="" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Enter Image URL</label>
                        <input type="text" name="background_image" id="edit_background_image" class="form-control" placeholder="https://example.com/image.jpg">
                        <small class="text-muted">Leave empty if uploading a file above or to keep current image</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" name="display_order" id="edit_display_order" class="form-control" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select name="is_active" id="edit_is_active" class="form-select">
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Hero Section</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Image preview for create modal
document.getElementById('createImageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('createImagePreview');
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.style.display = 'block';
            preview.querySelector('img').src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// Image preview for edit modal
document.getElementById('editImageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('editImagePreview');
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.style.display = 'block';
            preview.querySelector('img').src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

function editHero(id) {
    fetch(`/api/website-content/hero-sections/${id}`, {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Hero data:', data);

        document.getElementById('edit_title').value = data.title || '';
        document.getElementById('edit_subtitle').value = data.subtitle || '';
        document.getElementById('edit_cta_text').value = data.cta_text || '';
        document.getElementById('edit_cta_link').value = data.cta_link || '';
        document.getElementById('edit_background_image').value = data.background_image || '';
        document.getElementById('edit_display_order').value = data.display_order || 0;
        document.getElementById('edit_is_active').value = data.is_active ? '1' : '0';

        // Show current image preview if exists
        const currentPreview = document.getElementById('currentImagePreview');
        if (data.background_image) {
            currentPreview.style.display = 'block';
            currentPreview.querySelector('img').src = data.background_image;
        } else {
            currentPreview.style.display = 'none';
        }

        // Reset new image preview
        document.getElementById('editImagePreview').style.display = 'none';
        document.getElementById('editImageUpload').value = '';

        document.getElementById('editHeroForm').action = `/rock/hero-sections/${id}/edit`;

        new bootstrap.Modal(document.getElementById('editHeroModal')).show();
    })
    .catch(error => {
        console.error('Error loading hero section:', error);
        alert('Error loading hero section: ' + error.message);
    });
}

function deleteHero(id, title) {
    if (confirm(`Are you sure you want to delete "${title}"?`)) {
        fetch(`/api/website-content/hero-sections/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                location.reload();
            } else {
                alert('Error deleting hero section');
            }
        })
        .catch(error => {
            alert('Error deleting hero section');
            console.error(error);
        });
    }
}
</script>

{% endblock %}
