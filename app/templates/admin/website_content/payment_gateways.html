{% extends "admin/base.html" %}
{% block title %}Payment Gateways - Admin{% endblock %}

{% block content %}
<style>
    .gateway-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
        transition: all 0.3s;
    }
    .gateway-card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .gateway-card.active {
        border-color: #22c55e;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.02), transparent);
    }
    .gateway-card.inactive {
        opacity: 0.7;
        border-color: #e5e7eb;
    }
    .gateway-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f3f4f6;
    }
    .gateway-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .gateway-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
    }
    .gateway-icon.paypal {
        background: linear-gradient(135deg, #003087, #009cde);
        color: white;
    }
    .gateway-icon.stripe {
        background: linear-gradient(135deg, #635bff, #7a73ff);
        color: white;
    }
    .gateway-name {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 4px;
    }
    .gateway-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .gateway-status.active {
        background: #dcfce7;
        color: #15803d;
    }
    .gateway-status.inactive {
        background: #f3f4f6;
        color: #6b7280;
    }
    .gateway-status.sandbox {
        background: #fef3c7;
        color: #b45309;
    }
    .credential-group {
        background: #f9fafb;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .credential-group h6 {
        font-size: 13px;
        font-weight: 700;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .credential-group h6 i {
        color: #667eea;
    }
    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 6px;
    }
    .form-control {
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 10px 14px;
        font-size: 14px;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn-save {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        color: white;
    }
    .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: #e5e7eb;
        border-radius: 26px;
        transition: 0.3s;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
        background: #22c55e;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e7eb;
    }
    .stat-value {
        font-size: 28px;
        font-weight: 800;
        color: #1e293b;
    }
    .stat-label {
        font-size: 13px;
        color: #6b7280;
        margin-top: 4px;
    }
    .init-section {
        background: linear-gradient(135deg, #eff6ff, #f0f9ff);
        border: 2px dashed #3b82f6;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        margin-bottom: 32px;
    }
    .init-section h3 {
        color: #1e40af;
        margin-bottom: 12px;
    }
    .init-section p {
        color: #3b82f6;
        margin-bottom: 20px;
    }
    .transactions-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }
    .transactions-table th {
        background: #f9fafb;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 12px 16px;
    }
    .transactions-table td {
        padding: 12px 16px;
        font-size: 14px;
        border-top: 1px solid #f3f4f6;
    }
    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    .status-badge.completed {
        background: #dcfce7;
        color: #15803d;
    }
    .status-badge.pending {
        background: #fef3c7;
        color: #b45309;
    }
    .status-badge.failed {
        background: #fee2e2;
        color: #dc2626;
    }
    .nav-tabs .nav-link {
        color: #6b7280;
        border: none;
        padding: 12px 20px;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link.active {
        color: #667eea;
        background: #f8fafc;
        border-bottom: 2px solid #667eea;
    }
    .tab-content {
        background: #f8fafc;
        padding: 20px;
        border-radius: 0 0 12px 12px;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 fw-bold" style="color: #1e293b;">
            <i class="bi bi-credit-card-2-front-fill me-3" style="color: #667eea;"></i>Payment Gateways
        </h2>
        <p class="text-muted mb-0">Configure payment methods for subscription payments</p>
    </div>
    <div>
        <a href="{{ url_for('admin.pricing_plans') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Pricing
        </a>
    </div>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" style="color: #667eea;">{{ stats.total_transactions }}</div>
        <div class="stat-label">Total Transactions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #22c55e;">{{ stats.successful_transactions }}</div>
        <div class="stat-label">Successful Payments</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #f59e0b;">${{ "%.2f"|format(stats.total_revenue) }}</div>
        <div class="stat-label">Total Revenue</div>
    </div>
</div>

{% if not gateways %}
<!-- Initialize Gateways -->
<div class="init-section">
    <i class="bi bi-credit-card-2-front" style="font-size: 48px; color: #3b82f6;"></i>
    <h3>No Payment Gateways Configured</h3>
    <p>Initialize PayPal and Stripe payment gateways to start accepting payments</p>
    <form method="POST" action="{{ url_for('admin.init_payment_gateways') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-lg me-2"></i>Initialize Payment Gateways
        </button>
    </form>
</div>
{% else %}
<!-- Gateway Cards -->
<div class="row">
    {% for gateway in gateways %}
    <div class="col-lg-6">
        <div class="gateway-card {{ 'active' if gateway.is_active else 'inactive' }}">
            <div class="gateway-header">
                <div class="gateway-info">
                    <div class="gateway-icon {{ gateway.name }}">
                        <i class="bi {{ gateway.icon or 'bi-credit-card' }}"></i>
                    </div>
                    <div>
                        <div class="gateway-name">{{ gateway.display_name }}</div>
                        <div class="d-flex gap-2">
                            <span class="gateway-status {{ 'active' if gateway.is_active else 'inactive' }}">
                                <i class="bi bi-{{ 'check-circle-fill' if gateway.is_active else 'x-circle' }}"></i>
                                {{ 'Active' if gateway.is_active else 'Inactive' }}
                            </span>
                            {% if gateway.is_sandbox %}
                            <span class="gateway-status sandbox">
                                <i class="bi bi-box"></i>
                                Sandbox Mode
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('admin.toggle_payment_gateway', id=gateway.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm {{ 'btn-success' if not gateway.is_active else 'btn-outline-secondary' }}">
                        <i class="bi bi-{{ 'play-fill' if not gateway.is_active else 'pause-fill' }}"></i>
                        {{ 'Enable' if not gateway.is_active else 'Disable' }}
                    </button>
                </form>
            </div>

            <form method="POST" action="{{ url_for('admin.update_payment_gateway', id=gateway.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#settings-{{ gateway.id }}">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#credentials-{{ gateway.id }}">API Credentials</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Settings Tab -->
                    <div class="tab-pane fade show active" id="settings-{{ gateway.id }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Display Name</label>
                                <input type="text" class="form-control" name="display_name" value="{{ gateway.display_name }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Supported Currencies</label>
                                <input type="text" class="form-control" name="supported_currencies" value="{{ gateway.supported_currencies }}" placeholder="USD,EUR,GBP">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="2">{{ gateway.description or '' }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Transaction Fee (%)</label>
                                <input type="number" class="form-control" name="transaction_fee_percent" value="{{ gateway.transaction_fee_percent or 0 }}" step="0.1" min="0" max="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-block mb-2">Environment</label>
                                <div class="form-check form-check-inline">
                                    <input type="checkbox" class="form-check-input" name="is_sandbox" value="1" id="sandbox-{{ gateway.id }}" {{ 'checked' if gateway.is_sandbox else '' }}>
                                    <label class="form-check-label" for="sandbox-{{ gateway.id }}">
                                        <i class="bi bi-box me-1"></i>Sandbox/Test Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credentials Tab -->
                    <div class="tab-pane fade" id="credentials-{{ gateway.id }}">
                        {% if gateway.name == 'paypal' %}
                        <!-- PayPal Credentials -->
                        <div class="credential-group">
                            <h6><i class="bi bi-box"></i> Sandbox Credentials (Testing)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Sandbox Client ID</label>
                                    <input type="text" class="form-control" name="paypal_sandbox_client_id" value="{{ gateway.paypal_sandbox_client_id or '' }}" placeholder="AZ...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sandbox Client Secret</label>
                                    <input type="password" class="form-control" name="paypal_sandbox_client_secret" value="{{ gateway.paypal_sandbox_client_secret or '' }}" placeholder="EL...">
                                </div>
                            </div>
                        </div>
                        <div class="credential-group">
                            <h6><i class="bi bi-shield-check"></i> Live Credentials (Production)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Live Client ID</label>
                                    <input type="text" class="form-control" name="paypal_client_id" value="{{ gateway.paypal_client_id or '' }}" placeholder="AZ...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Live Client Secret</label>
                                    <input type="password" class="form-control" name="paypal_client_secret" value="{{ gateway.paypal_client_secret or '' }}" placeholder="EL...">
                                </div>
                            </div>
                        </div>
                        {% elif gateway.name == 'stripe' %}
                        <!-- Stripe Credentials -->
                        <div class="credential-group">
                            <h6><i class="bi bi-box"></i> Test Credentials (Sandbox)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Test Publishable Key</label>
                                    <input type="text" class="form-control" name="stripe_sandbox_publishable_key" value="{{ gateway.stripe_sandbox_publishable_key or '' }}" placeholder="pk_test_...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Test Secret Key</label>
                                    <input type="password" class="form-control" name="stripe_sandbox_secret_key" value="{{ gateway.stripe_sandbox_secret_key or '' }}" placeholder="sk_test_...">
                                </div>
                            </div>
                        </div>
                        <div class="credential-group">
                            <h6><i class="bi bi-shield-check"></i> Live Credentials (Production)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Live Publishable Key</label>
                                    <input type="text" class="form-control" name="stripe_publishable_key" value="{{ gateway.stripe_publishable_key or '' }}" placeholder="pk_live_...">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Live Secret Key</label>
                                    <input type="password" class="form-control" name="stripe_secret_key" value="{{ gateway.stripe_secret_key or '' }}" placeholder="sk_live_...">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="credential-group">
                            <h6><i class="bi bi-link-45deg"></i> Webhook Configuration</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Webhook Secret</label>
                                    <input type="password" class="form-control" name="webhook_secret" value="{{ gateway.webhook_secret or '' }}" placeholder="whsec_...">
                                    <small class="text-muted">For verifying webhook signatures from {{ gateway.display_name }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                    <form method="POST" action="{{ url_for('admin.delete_payment_gateway', id=gateway.id) }}" onsubmit="return confirm('Delete {{ gateway.display_name }}?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </form>
                    <button type="submit" class="btn btn-save">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add New Gateway Button -->
<div class="text-center mt-4">
    <form method="POST" action="{{ url_for('admin.init_payment_gateways') }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-plus-lg me-2"></i>Re-initialize Missing Gateways
        </button>
    </form>
</div>

<!-- Recent Transactions -->
{% if recent_transactions %}
<div class="mt-5">
    <h4 class="mb-3"><i class="bi bi-receipt me-2" style="color: #667eea;"></i>Recent Transactions</h4>
    <div class="transactions-table">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Gateway</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in recent_transactions %}
                <tr>
                    <td><code>{{ tx.transaction_id[:20] }}...</code></td>
                    <td>
                        <i class="bi {{ 'bi-paypal' if tx.gateway_name == 'paypal' else 'bi-credit-card' }} me-1"></i>
                        {{ tx.gateway_name|title }}
                    </td>
                    <td><strong>${{ "%.2f"|format(tx.amount) }}</strong> {{ tx.currency }}</td>
                    <td><span class="status-badge {{ tx.status }}">{{ tx.status|title }}</span></td>
                    <td>{{ tx.created_at.strftime('%b %d, %Y %H:%M') if tx.created_at else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Integration Guide -->
<div class="card mt-5" style="border: none; background: linear-gradient(135deg, #f0f9ff, #eff6ff); border-radius: 16px;">
    <div class="card-body p-4">
        <h5 class="card-title mb-3" style="color: #1e40af;">
            <i class="bi bi-info-circle me-2"></i>Integration Guide
        </h5>
        <div class="row">
            <div class="col-md-6">
                <h6 style="color: #1e40af;"><i class="bi bi-paypal me-2"></i>PayPal Setup</h6>
                <ol class="mb-4" style="color: #3b82f6; font-size: 14px;">
                    <li>Go to <a href="https://developer.paypal.com" target="_blank">PayPal Developer</a></li>
                    <li>Create a new app in the Dashboard</li>
                    <li>Copy Client ID and Secret</li>
                    <li>Use Sandbox credentials for testing</li>
                    <li>Switch to Live credentials when ready</li>
                </ol>
            </div>
            <div class="col-md-6">
                <h6 style="color: #1e40af;"><i class="bi bi-credit-card me-2"></i>Stripe Setup</h6>
                <ol class="mb-0" style="color: #3b82f6; font-size: 14px;">
                    <li>Go to <a href="https://dashboard.stripe.com" target="_blank">Stripe Dashboard</a></li>
                    <li>Navigate to Developers â†’ API Keys</li>
                    <li>Copy Publishable and Secret keys</li>
                    <li>Use Test keys (pk_test_, sk_test_) for testing</li>
                    <li>Switch to Live keys when ready</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

